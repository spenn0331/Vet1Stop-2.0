"use client";

import React, { useRef, useCallback, useState, useEffect } from 'react';
import { FixedSizeGrid as Grid } from 'react-window';
import AutoSizer from 'react-virtualized-auto-sizer';
import { HealthResource } from './ResourceDetailView';

interface VirtualizedResourceGridProps {
  resources: HealthResource[];
  savedResources: string[];
  onResourceSelect: (resource: HealthResource) => void;
  onSaveResource: (resourceId: string) => void;
  onRateResource: (resourceId: string, rating: number) => void;
}

const VirtualizedResourceGrid: React.FC<VirtualizedResourceGridProps> = ({
  resources,
  savedResources,
  onResourceSelect,
  onSaveResource,
  onRateResource
}) => {
  // Calculate grid dimensions based on viewport width
  const [columnCount, setColumnCount] = useState(3);
  const gridRef = useRef<Grid>(null);

  // Update column count based on screen size
  useEffect(() => {
    const handleResize = () => {
      const width = window.innerWidth;
      if (width < 640) {
        setColumnCount(1);
      } else if (width < 1024) {
        setColumnCount(2);
      } else {
        setColumnCount(3);
      }
    };

    handleResize(); // Initial call
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // When resources or column count change, reset grid scroll position
  useEffect(() => {
    if (gridRef.current) {
      gridRef.current.scrollToItem({
        align: 'start',
        columnIndex: 0,
        rowIndex: 0
      });
    }
  }, [resources, columnCount]);

  // Memoized cell renderer to avoid unnecessary re-renders
  const ResourceCardCell = useCallback(
    ({ columnIndex, rowIndex, style }: { columnIndex: number; rowIndex: number; style: React.CSSProperties }) => {
      const index = rowIndex * columnCount + columnIndex;
      
      // Return empty cell if beyond resource count
      if (index >= resources.length) {
        return <div style={style} />;
      }
      
      const resource = resources[index];
      const resourceId = resource._id || resource.id || '';
      const isSaved = savedResources.includes(resourceId);
      
      // This renders a simplified version of the ResourceCard for optimization
      return (
        <div style={{
          ...style,
          padding: '8px',
        }}>
          <div 
            className="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 hover:shadow-lg transition-shadow duration-200 cursor-pointer h-full"
            onClick={() => onResourceSelect(resource)}
          >
            {/* Card header */}
            <div className="bg-blue-700 p-4 flex justify-between items-center">
              <div className="bg-blue-800 rounded-lg p-3">
                <div className="h-16 w-16 text-white flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-10 h-10">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z" />
                  </svg>
                </div>
              </div>
              <button 
                onClick={(e) => {
                  e.stopPropagation();
                  onSaveResource(resourceId);
                }}
                className="text-white hover:text-yellow-300 transition-colors"
                aria-label={isSaved ? "Remove from saved resources" : "Save resource"}
              >
                <svg 
                  xmlns="http://www.w3.org/2000/svg" 
                  viewBox="0 0 24 24" 
                  fill={isSaved ? "currentColor" : "none"}
                  stroke="currentColor" 
                  className={`h-6 w-6 ${isSaved ? 'text-yellow-300' : ''}`}
                >
                  <path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
                </svg>
              </button>
            </div>
            
            {/* Card content */}
            <div className="p-4">
              <h3 className="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">{resource.title}</h3>
              <p className="text-gray-600 text-sm mb-3 line-clamp-2">
                {resource.description}
              </p>
              
              {/* Card footer */}
              <div className="flex justify-between items-center mt-2">
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onResourceSelect(resource);
                  }}
                  className="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center"
                >
                  View Details
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4 ml-1">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
                  </svg>
                </button>
                
                {resource.isFeatured && (
                  <span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">
                    Featured
                  </span>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    },
    [resources, savedResources, onResourceSelect, onSaveResource, columnCount]
  );

  // Calculate row count based on resources length and column count
  const rowCount = Math.ceil(resources.length / columnCount);

  return (
    <div className="w-full h-[800px]">
      <AutoSizer>
        {({ height, width }) => (
          <Grid
            ref={gridRef}
            columnCount={columnCount}
            columnWidth={width / columnCount}
            height={height}
            rowCount={rowCount}
            rowHeight={360} // Adjust based on card size
            width={width}
          >
            {ResourceCardCell}
          </Grid>
        )}
      </AutoSizer>
    </div>
  );
};

export default VirtualizedResourceGrid;
