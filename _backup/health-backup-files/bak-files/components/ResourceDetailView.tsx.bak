"use client";

import React, { useState } from 'react';
import { 
  ArrowTopRightOnSquareIcon,
  ShieldCheckIcon,
  UserGroupIcon,
  CheckBadgeIcon
} from '@heroicons/react/24/outline';
import Modal from '@/components/ui/modal';
import Link from 'next/link';

// Import modular components
import {
  ResourceTypeBadge,
  StarRating,
  DetailsInfoSection,
  ResourceTags,
  formatDate
} from './resource-detail/DetailSections';

import {
  ActionButtons,
  RatingInput,
  FeedbackSuccess,
  ResourceDescription,
  ResourceNotFound
} from './resource-detail/ActionComponents';

// Import new enhanced components
import EligibilitySection from './resource-detail/EligibilitySection';
import InteractiveContactSection from './resource-detail/InteractiveContactSection';
import RelatedResourcesSection from './resource-detail/RelatedResourcesSection';

// Resource interface definition
export interface HealthResource {
  _id?: string;
  id?: string;
  title: string;
  description: string;
  category?: string;
  subcategory?: string;
  resourceType?: string;
  contact?: {
    phone?: string;
    email?: string;
    website?: string;
  };
  phone?: string;
  email?: string;
  website?: string;
  location?: {
    address?: string;
    city?: string;
    state?: string;
    zipCode?: string;
  };
  address?: string;
  city?: string;
  state?: string;
  zipCode?: string;
  eligibility?: string;
  veteranType?: string | string[];
  serviceBranch?: string | string[];
  notEligible?: string;
  tags?: string[];
  thumbnail?: string;
  imageUrl?: string;
  logoUrl?: string;
  rating?: number;
  reviewCount?: number;
  lastUpdated?: string | Date;
  dateAdded?: string | Date;
  isFeatured?: boolean;
  operatingHours?: string;
  socialMedia?: {
    facebook?: string;
    twitter?: string;
    instagram?: string;
    linkedin?: string;
  };
  link?: string;
  organization?: string;
}

// Props for the component
interface ResourceDetailViewProps {
  resource: HealthResource | null;
  isOpen: boolean;
  onClose: () => void;
  onSave?: ((resource: HealthResource) => void) | (() => void);
  onShare?: (resource: HealthResource) => void;
  onRate?: (rating: number) => void;
  onViewRelated?: (resource: HealthResource) => void;
  isSaved?: boolean;
  relatedResources?: HealthResource[];
  isLoadingRelated?: boolean;
}

export default function ResourceDetailView({
  resource,
  isOpen,
  onClose,
  onSave,
  onShare,
  onRate,
  onViewRelated,
  isSaved = false,
  relatedResources = [],
  isLoadingRelated = false
}: ResourceDetailViewProps) {
  // Add useEffect for custom scrollbar styling
  React.useEffect(() => {
    // Add custom scrollbar styles
    const style = document.createElement('style');
    style.textContent = `
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
      }
    `;
    document.head.appendChild(style);
    
    return () => {
      document.head.removeChild(style);
    };
  }, []);
  const [expanded, setExpanded] = useState<boolean>(false);
  const [localIsSaved, setLocalIsSaved] = useState<boolean>(isSaved);
  const [showShareSuccess, setShowShareSuccess] = useState<boolean>(false);
  const [rating, setRating] = useState<number>(resource?.rating || 0);
  const [showRatingSuccess, setShowRatingSuccess] = useState<boolean>(false);

  // Function to handle save action
  const handleSave = () => {
    if (onSave && resource) {
      onSave(resource);
      setLocalIsSaved(!localIsSaved);
    }
  };

  // Function to handle share action
  const handleShare = () => {
    if (onShare && resource) {
      onShare(resource);
      setShowShareSuccess(true);
      
      // Hide success message after 3 seconds
      setTimeout(() => {
        setShowShareSuccess(false);
      }, 3000);
    }
  };

  // Function to handle rating
  const handleRate = (value: number) => {
    setRating(value);
    
    if (onRate) {
      onRate(value);
      
      // Show success message
      setShowRatingSuccess(true);
      
      // Hide success message after 3 seconds
      setTimeout(() => {
        setShowRatingSuccess(false);
      }, 3000);
    }
  };

  // Check if resource exists
  if (!resource) {
    return (
      <Modal isOpen={isOpen} onClose={onClose}>
        <ResourceNotFound onClose={onClose} />
      </Modal>
    );
  }

  return (
    <Modal isOpen={isOpen} onClose={onClose} size="lg">
      <div className="md:p-2 pt-4" style={{ marginTop: '10px' }}>
        {/* Header - Improved responsive layout */}
        <div className="flex flex-col sm:flex-row justify-between items-start gap-3">
          <div className="flex-1 min-w-0 mr-4">
            <h3 className="text-xl sm:text-2xl font-semibold text-[#1A2C5B] mb-1">
              {resource.title}
            </h3>
            
            <div className="flex flex-wrap gap-2 mb-3">
              {resource.resourceType && (
                <ResourceTypeBadge resourceType={resource.resourceType} />
              )}
              
              {resource.isFeatured && (
                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  <CheckBadgeIcon className="h-3 w-3 mr-1" />
                  Featured
                </span>
              )}
            </div>
            
            {/* Rating */}
            <StarRating rating={resource.rating} reviewCount={resource.reviewCount} />
          </div>
          
          {/* Action buttons */}
          <ActionButtons
            resource={resource}
            isSaved={localIsSaved}
            onSave={handleSave}
            onShare={handleShare}
            shareSuccess={showShareSuccess}
          />
        </div>
        
        {/* Content area - Improved scrolling with responsive height */}
        <div className="mt-3 space-y-6 max-h-[calc(100vh-280px)] sm:max-h-[calc(100vh-240px)] md:max-h-[calc(100vh-220px)] overflow-y-auto px-1 pb-4 custom-scrollbar">
          {/* Description */}
          <ResourceDescription
            description={resource.description}
            expanded={expanded}
            onToggleExpand={() => setExpanded(prev => !prev)}
          />

          {/* Enhanced Interactive Contact Information */}
          <InteractiveContactSection resource={resource} />
          
          {/* Eligibility Requirements */}
          <EligibilitySection resource={resource} />

          {/* Details Information */}
          <DetailsInfoSection resource={resource} />

          {/* Tags */}
          {resource.tags && resource.tags.length > 0 && (
            <ResourceTags tags={resource.tags} />
          )}
          
          {/* Related Resources */}
          {relatedResources.length > 0 && (
            <RelatedResourcesSection
              resource={resource}
              relatedResources={relatedResources}
              isLoading={isLoadingRelated}
              onViewResource={onViewRelated || (() => {})}
            />
          )}
        </div>
        
        {/* Rating and Feedback section at the bottom - Improved spacing */}
        <div className="mt-4 pt-4 border-t border-gray-200">
          <h3 className="text-lg font-semibold text-[#1A2C5B] mb-3">Rate this Resource</h3>
          
          {showRatingSuccess ? (
            <FeedbackSuccess />
          ) : (
            <RatingInput 
              onRate={handleRate} 
              currentRating={rating} 
            />
          )}
        </div>
        
        {/* Website Button - Improved spacing */}
        {(resource.website || (resource.contact && resource.contact.website)) && (
          <div className="mt-4">
            <Link 
              href={resource.website || resource.contact?.website || '#'}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-flex w-full justify-center items-center px-4 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-[#1A2C5B] hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Visit Website
              <ArrowTopRightOnSquareIcon className="ml-2 h-5 w-5" />
            </Link>
          </div>
        )}
        
        {/* Footer buttons - Improved spacing and responsive layout */}
        <div className="flex flex-wrap justify-between gap-2 mt-4 border-t border-gray-200 pt-4">
          <button
            onClick={onClose}
            className="px-3 py-1.5 bg-white border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            Close
          </button>
        </div>
        
        {/* Last updated */}
        {resource.lastUpdated && (
          <div className="text-xs text-gray-500 mt-4 text-right">
            Last updated: {formatDate(resource.lastUpdated)}
          </div>
        )}
      </div>
    </Modal>
  );
}
